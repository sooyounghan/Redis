-----
### hyperloglog를 이용한 애플리케이션 미터링
-----
1. 클라우드 컴퓨팅 특성 중 하나는 Pay as you go로, 즉, 서비스를 사용한 만큼 지불해야 한다는 것을 의미
   - 따라서, 사용자가 얼마나 서비스를 사용했는지 정확하게 측정할 수 있어야 함

2. 미터링 솔루션은 사용자의 서비스 사용 내역을 이용하므로 대용량 데이터를 처리할 수 있어야 함
   - 서비스 규모에 따라 초당 수천 건 이상의 작업이 발생할 수 있으며, 따라서 미터링 솔루션은 높은 처리량과 낮은 대기 시간을 가져야 함

3. 예를 들어, 서버와 클라이언트에서 발생하는 로그를 수집하고 인덱싱해 사용자가 특정 로그를 검색하고 조회할 수 있는 서비스를 클라우드 환경에서 제공한다고 생각
   - 이 때, 로그를 수집할 때마다 서비스의 API를 호출하고, 하나의 API 호출마다 건별로 과금을 매기는 정책이 있다면, 사용자별 API 호출 횟수를 카운팅해야 함
   - 1초에 100개씩 로그가 쌓이는 서버가 존재한다고 가정
     + 한 시간이면 36만개 로그의, 한 달이면 2억 6천 개 정도의 로그가 쌓일 수 있음
     + 이런 서버가 한 대가 아니라 여러 대 존재한다면 총 몇 개의 로그가 쌓였는지 측정하는 자체가 큰 부하

4. 레디스의 hyperloglog를 사용할 수 있는 경우
   - 집합 내 유일한 데이터 갯수 카운팅
   - 1% 미만 오차는 허용 가능
   - 카운팅할 떄 사용한 정확한 데이터를 다시 확인하지 않아도 됨

5. 일반적인 방법으로는 중복을 피하기 위해 저장된 데이터를 모두 기억해야 하므로, 저장되는 데이터가 많아질수록 그만큼 많은 메모리 사용
   - 하지만, 저장된 값을 다시 확인하지 않아도 되는 경우여서 hyperloglog를 이용할 수 있다면, 최소한의 메모리만을 사용해 중복되지 않는 데이터 개수 계산 가능
  
6. 레디스에서 hyperloglog를 이용해 유저의 월별 API 호출 횟수를 계산하는 방법
   - 각 유저를 구분하는 ID를 키로 사용하고, API를 호출할 때마다 저장되는 로그의 식별자를 hyperloglog에 저장할 수 있음
   - 예를 들어, 2022년 11월에 ID가 245인 유저의 호출 횟수를 계산하려면 API를 호출할 때마다 202211:user:245라는 키에 PFADD 커맨드를 사용해 로그 식별자를 저장
```redis
> PFADD 202211:user:245 49483
(integer) 1

> PFADD 202211:user:245 32714
(integer) 1

> PFADD 202211:user:245 49483
(integer) 0

> PFCOUNT 202211:user:245
(integer) 2
```
  - ID가 245인 유저가 PFADD 커맨드를 사용해 API를 호출하는 로그 식별자를 저장하는 상황을 보여줌
  - PFCOUNT 커맨드를 이용하면 hyperloglog에 저장된 중복되지 않은 데이터 개수 확인 가능
  - PFADD 커맨드로 49483라는 로그를 두 번 저장하고, 32714라는 로그를 한 번 저장했지만, PFCOUNT를 사용해 확인했을 때 저장된 값은 2개임을 알 수 있음

7. hyperloglog는 set과 비슷하지만, 저장되는 용량은 12KB로 고정되므로, 공간을 효율적으로 사용할 수 있음
8. PFMERGE 커맨드를 이용하면 여러 개 hyperloglog를 합칠 수 있으므로 분기별 또는 연도별 합산 데이터를 간편하게 계산 가능
```redis
> PFMERGE 2022:user:245 202211:user:245 202212:user:245
OK

> PFCOUNT 2022:user:245
(integer) 2
```
