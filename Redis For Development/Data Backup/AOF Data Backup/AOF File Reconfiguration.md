-----
### AOF 파일을 재구성하는 방법
-----
1. AOF 파일을 이용한 백업 기능을 안정적으로 사용하려면 점점 커지는 파일을 주기적으로 압축시키는 재구성(Rewrite) 작업 필요
   - RDB에서와 마찬가지로 특정 조건에 자동으로 재구성되도록 설정할 수도 있으며, 사용자가 원하는 시점에 커맨드를 이용해 재구성시킬 수 있음
   - 사용자가 원하는 시점에 커맨드를 이용해 재구성시킬 수 있음

2. 재구성 과정
   - 이 때, 압축, 즉 재구성은 기존 디스크에 저장됐던 AOF 파일을 사용하는 것이 아니라 레디스 메모리에 있는 데이터를 읽어와서 새로운 파일로 저장하는 형태로 동작
   - 설정 파일에서 기본 옵션인 aof-use-rdb-preamble yes를 no로 변경하지 않는다면, 이 데이터는 RDB 파일 형태로 저장
   - RDB 파일을 저장할 때와 마찬가지로 AOF 파일을 재구성할 때도 fork를 이용해 자식 프로세스를 생성하며, 이 자식 프로세스가 AOF 파일을 재구성해 저장

3. 버전 7 이전 관리 : 버전 7 이전까지는 AOF는 하나의 파일로 관리
   - AOF 파일의 앞부분은 메모리의 데이터를 읽어와 바이너리 형태로 저장한 RDB 파일이 위치
   - 이후 레디스의 메모리를 변경한 커맨드 로그들은 RSEP 형태로 RDB 파일 뒤에 쌓이는 형태(Append-Only)로 증가
<div align="center">
<img src="https://github.com/user-attachments/assets/c1495da2-a020-4a37-90ca-8ad1879cac5f">
</div>

<div align="center">
<img src="https://github.com/user-attachments/assets/78a95543-870d-45ac-b952-d2f4ba253b85">
</div>

   - 동작 과정
     + 레디스는 fork를 이용해 자식 프로세스를 생성 : 생성된 자식 프로세스는 레디스 메모리의 데이터를 읽어와 신규로 생성한 임시 파일에 저장
     + 백그라운드로 위 과정이 진행되는 동안 레디스 메모리의 데이터가 변경된 내역은 기존 AOF 파일과 인메모리 버퍼에 동시에 저장
     + 첫 번째 단계의 AOF 재구성 과정이 끝나면 인메모리 버퍼에 저장된 내용을 첫 번째 단계의 임시 파일 마지막에 추가
     + 생성된 임시 파일로 기존 AOF 파일을 덮어씌움
   - 이 때, 두 번째 과정에서 RDB 파일이 저장되는 동안, 데이터가 변경된 동일한 로그가 AOF 파일과 인메모리 버퍼에 이중으로 저장
   - 또한, 하나의 AOF 파일 내의 바이너리 형태와 RESP의 텍스트 형태의 데이터가 함께 저장되어 수동으로 AOF 파일을 처리할 때 관리가 복잡해질 수 있다는 단점 존재

4. 레디스 버전 7.0에서 AOF 파일 저장 구조
<div align="center">
<img src="https://github.com/user-attachments/assets/4efff496-9782-463d-86d2-9d968e77a6e3">
</div>

   - 버전 7 이후에서 AOF는 기본이 되는 바이너리 형태의 RDB 파일, 증가하는 RESP의 텍스트 형태의 AOF 파일로 나눠서 데이터 관리
   - 또한, 현재 레디스가 바라보고 있는 파일이 어떤 것인지 나타내는 Manifest 파일을 추가적으로 도입
     + Manifest 파일은 RDB와 AOF 파일이 어떤 것인지 알려주는 역할
   - 세 파일은 모두 설정 파일에 지정한 appenddirname 이름 폴더 내 저장
   -  AOF가 재구성될 때마다 AOF를 구성하고 있는 각 RDB와 AOF의 파일명과 번호 그리고 Mainfest 파일 내부의 seq 값도 1씩 증가
<div align="center">
<img src="https://github.com/user-attachments/assets/0a21bc8f-1c2b-409a-a83a-c767b9df4554">
</div>

   - 버전 7.0 이후 AOF 재구성 방식
<div align="center">
<img src="https://github.com/user-attachments/assets/18fe618f-c713-4f5e-8b52-4e22752be3ab">
</div>

   - 레디스 인스턴스는 fork를 이용해 자식 프로세스를 생성 : 생성된 자식 프로세스는 레디스 메모리의 데이터를 읽어와 신규로 생성한 임시 파일에 저장
   - 백그라운드로 위 과정이 진행되는 동안, 레디스 메모리의 데이터가 변경된 내역은 신규 AOF 파일에 저장
   - 첫 번쨰 단계의 AOF 재구성이 끝나면, 임시 Manifest 파일을 생성한 뒤, 변경된 버전으로 Mainfest 파일 내용을 업데이트
   - 생성된 임시 Mainfest 파일로 기존 Mainfest 파일을 덮어 씌운 뒤, 이전 버전의 AOF, RDB 파일들을 삭제

   - 기존 버전의 단계의 비효율을 줄일 수 있어 훨씬 간단한 과정으로 데이터를 저장할 수 있음을 확인할 수 있음

5. 앞서 aof-use-rdb-preamble 옵션에 의해 압축되는 데이터 파일은 RDB 형태로 저장
   - 이를 no로 변경했다면, 베이스 파일은 *.base.rdb 형태가 아닌 *.base.aof라는 이름으로 저장되며, 저장되는 형태도 RESP 프로토콜 형태의 텍스트로 변경

 6. 여기서 중요한 점은 레디스에서 AOF 파일의 재구성 과정은 모두 순차 입출력(Sequential I/O)만을 사용하므로 디스크에 접근하는 모든 과정이 굉장히 효율적
   - 레디스의 서버는 복원 시 순차적으로 데이터를 로드하는 용도로만 AOF 파일을 사용
   - 파일 내에서 직접 데이터를 검색할 필요가 없으므로 랜덤 입출력(Random I/O)을 고려할 이유가 없음
   - 이는 RDB 파일을 저장할 때도 동일하며, 파일을 저장할 때 랜덤 입출력을 고려하지 않는다는 점은 장점
