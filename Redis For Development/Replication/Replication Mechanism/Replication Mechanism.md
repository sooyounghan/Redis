-----
### 복제 메커니즘
-----
1. 레디스에서 복제 메커니즘은 자동으로 이뤄지며 사용자의 개입을 필요로 하지 않음
2. 버전 7 이전에서는 repl-diskless-sync 옵션 기본 값이 no
<div align="center">
<img src="https://github.com/user-attachments/assets/61811700-d517-494c-924e-f5352d0d71e3">
</div>

   - REPLICAOF 커맨드로 복제 연결 시도
   - 마스터 노드에서는 fork로 자식 프로세스를 만든 뒤 RDB 스냅샷을 생성
   - 두번째 과정 동안 마스터 노드에서 수행된 모든 데이터 셋 변경 작업은 레디스 프로토콜(RESP) 형태로 마스터 복제 버퍼에 저장
   - RDB 파일이 생성 완료되면 파일은 복제본 노드로 복사
   - 복제본에 저장됐던 모든 내용을 모두 삭제한 뒤 RDB 파일을 이용해 데이터를 로딩
   - 복제 과정 동안 버퍼링 됐던 복제 버퍼의 데이터를 복제본으로 전달해 수행시킴

3. 이 때, 마스터 노드와 복제본 노드에는 각각 다음과 같은 로그가 남음
   - 마스터 노드 : 복제 요청을 받은 마스터 노드가 BGSAVE 커맨드를 이용해 디스크에 RDB 파일을 생성하는 로그를 볼 수 있음
<div align="center">
<img src="https://github.com/user-attachments/assets/9a16c553-35bb-4fc4-9eaa-e2c6efb71277">
</div>

   - 복제본 노드 : 마스터와의 통신을 확인한 후 마스터로부터 RDB 파일을 읽어오고, RDB 파일을 로드하는 과정이 남아있음
<div align="center">
<img src="https://github.com/user-attachments/assets/bebed593-af56-4a3e-9bf3-d7322ecc7a88">
</div>

   - 복제 과정에서 복제 속도는 디스크 I/O 처리량에 영향을 받음
   - 마스터에서 RDB 파일을 저장하는 시간, 복제본에서 RDB 파일을 읽어오는 과정 모두 디스크 I/O 속도에 영향을 받음
   - 만약 로컬 디스크에 RDB 파일을 쓰는 것이 아니라 NAS와 같은 원격 디스크를 사용한다면 디스크 I/O 속도는 더욱 느려질 수 있음

4. 버전 7 이후부터 repl-diskless-sync 옵션의 기본값은 yes : 디스크를 사용하지 않는 방식(Diskless)에서의 방식
<div align="center">
<img src="https://github.com/user-attachments/assets/878e66bd-847f-4c22-8a8b-f3c8617ba76d">
</div>

   - REPLICAOF 커맨드로 복제 연결 시도
   - 마스터 노드는 소켓 통신을 이용해 복제본 노드에 바로 연결되며, RDB 파일은 생성됨과 동시에 점진적으로 복제본의 소켓에 전송
   - 두 번째 과정 동안, 마스터 노드에서 수행된 모든 데이터셋 변경 작업은 레디스 프로토콜(RESP) 형태로 마스터 복제 버퍼에 저장
   - 소켓에서 읽어온 RDB 파일을 복제본의 디스크에 저장
   - 복제본에 저장된 모든 데이터를 모두 삭제한 뒤, RDB 파일 내용을 메모리에 로딩
   - 복제 버퍼의 데이터를 복제본으로 전달해 수행
   - 이 과정에서 복제본의 repl-diskless-load 옵션은 기본적으로 disabled 이므로, 소켓에서 읽어온 RDB 스냅샷 데이터를 바로 로드하지 않고, 일단 복제본 노드의 디스크에 저장하는 과정을 거침
     + 복제본 노드는 마스터에서 가져온 데이터를 불러오기 전 자신의 데이터를 모두 삭제하는 과정을 거쳐야 하는데, 이 때 소켓 통신으로 받아온 RDB 데이터가 정상적인지 미리 확인할 수 없으므로 모두 삭제하기 전 자신의 디스크로 데이터를 저장하는 과정을 선행함으로 데이터 안정성 확보

   - 디스크를 사용하지 않는 방식으로 복제를 시도할 때의 마스터 노드의 로그 : 복제 요청을 받은 마스터 노드는 복제본의 소켓으로 디스크를 사용하지 않고 RDB 데이터를 보내는 로그 확인 가능
<div align="center">
<img src="https://github.com/user-attachments/assets/77b1925f-f43f-4063-ab23-6bbe9ccd0db2">
</div>

   - 복제본 노드 로그 : 마스터와의 통신을 확인한 후 마스터로부터 디스크를 사용하지 않는 방식으로 RDB 파일을 읽어오고, RDB 파일을 로드
<div align="center">
<img src="https://github.com/user-attachments/assets/b46a751c-190c-45a4-99de-86bc5ba75b8a">
</div>

   - 디스크의 I/O가 느리고 네트워크가 빠른 경우 디스크를 사용하지 않는 복제 방식을 사용하는 것이 더 빠르게 복제 연결을 완료할 수 있는 방법

5. 기존에 디스클 사용하는 복제를 사용했을 경우 RDB 파일이 생성되는 도중 다른 노드에서 복제 연결 요청이 들어오면 이 연결은 큐에 저장되며, 기존 RDB 파일의 저장이 완료되면 여러 복제본이 한 번에 복제 연결을 시작할 수 있었음
   - 하지만 디스크를 사용하지 않는 방식에서 이미 하나의 복제본으로 복제 연결이 시작된 경우에는 복제 과정이 끝나기 전까지 다른 복제본과 연결은 수행 될 수 없으며, 다른 복제본들은 하나의 복제 연결이 끝날때까지 큐에서 대기해야 함
   - 이를 방지하기 위해 repl-diskless-sync-delay 옵션 사용 가능
```redis
repl-diskless-sync-delay 5
```
   - 이 값의 기본값은 5초로, 새로운 복제 연결이 들어오면 기본 5초를 기다린 뒤, 복제 연결을 시작
   - 이 기간 내 또 다른 복제 연결이 들어오면 마스터는 여러 복제본으로 소켓 통신을 연결해 한 번에 여러 개 복제본에 RDB 파일을 전송할 수 있음
   - 보통 네트워크가 유실돼 재동기화를 요청할 경우, 마스터에는 한 번에 여러 개의 복제본에서 복제 연결이 들어오는 것이 일반적이므로, 이 옵션을 활성화하는 것이 좋음
